<!-- pages/index/index.wxml -->

<!-- é¡¶éƒ¨çŠ¶æ€æ  -->
<view class="status-bar">
  <view class="status-info">
    <text>ğŸ• {{currentTime}}</text>
    <text class="status-mode" wx:if="{{serverInfo.mode}}">
      {{serverInfo.mode === 'production' ? 'æ­£å¼' : 'æ¨¡æ‹Ÿ'}}æ¨¡å¼
    </text>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view wx:if="{{isLoading && !filteredEvents.length}}" class="loading-container">
  <view class="loading-spinner">
    <text class="loading-icon">â³</text>
    <text class="loading-text">æ­£åœ¨åŠ è½½å®è§‚äº‹ä»¶æ•°æ®...</text>
  </view>
</view>

<!-- é”™è¯¯çŠ¶æ€ -->
<view wx:if="{{loadError && !filteredEvents.length}}" class="error-container">
  <text class="error-icon">âŒ</text>
  <text class="error-text">æ•°æ®åŠ è½½å¤±è´¥</text>
  <button class="btn btn-primary mt-20" bindtap="loadInitialData">
    é‡æ–°åŠ è½½
  </button>
</view>

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<view wx:if="{{!isLoading || filteredEvents.length > 0}}" class="container fade-in">
  
  <!-- å¤´éƒ¨æ“ä½œæ  -->
  <view class="header">
    <view class="header-title">
      <text class="title">ğŸ“… ä»Šæ—¥å®è§‚äº‹ä»¶</text>
      <text class="subtitle" wx:if="{{serverInfo.lastUpdated}}">
        æ›´æ–°äº {{formatTime(serverInfo.lastUpdated, 'HH:mm')}}
      </text>
    </view>
    
    <view class="header-actions">
      <button class="btn-icon" bindtap="onToggleFilters">
        <text class="icon-filter">ğŸ”</text>
      </button>
      <button 
        class="btn-refresh {{isRefreshing ? 'refreshing' : ''}}" 
        bindtap="onRefreshTap"
        disabled="{{isRefreshing}}"
      >
        {{isRefreshing ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°'}}
      </button>
    </view>
  </view>

  <!-- ç­›é€‰å™¨é¢æ¿ -->
  <view wx:if="{{showFilters}}" class="filter-panel card">
    <view class="filter-section">
      <text class="filter-label">é‡è¦æ€§ç­›é€‰:</text>
      <view class="filter-options">
        <view 
          wx:for="{{filterOptions.importance}}" 
          wx:key="value"
          class="filter-option {{filters.importance === item.value ? 'active' : ''}}"
          data-type="importance"
          data-value="{{item.value}}"
          bindtap="onFilterChange"
        >
          {{item.label}}
        </view>
      </view>
    </view>
    
    <view class="filter-section">
      <text class="filter-label">è´§å¸ç­›é€‰:</text>
      <view class="filter-options">
        <view 
          wx:for="{{filterOptions.currency}}" 
          wx:key="value"
          class="filter-option {{filters.currency === item.value ? 'active' : ''}}"
          data-type="currency"
          data-value="{{item.value}}"
          bindtap="onFilterChange"
        >
          {{item.label}}
        </view>
      </view>
    </view>
    
    <view class="filter-section">
      <text class="filter-label">æ’åºæ–¹å¼:</text>
      <view class="sort-options">
        <view 
          class="sort-option {{sortBy === 'time' ? 'active' : ''}}"
          data-sort="time"
          bindtap="onSortChange"
        >
          ğŸ• æŒ‰æ—¶é—´
        </view>
        <view 
          class="sort-option {{sortBy === 'importance' ? 'active' : ''}}"
          data-sort="importance"
          bindtap="onSortChange"
        >
          ğŸ”¥ æŒ‰é‡è¦æ€§
        </view>
      </view>
    </view>
    
    <view class="filter-actions">
      <button class="btn btn-secondary" bindtap="onResetFilters">
        é‡ç½®ç­›é€‰
      </button>
    </view>
  </view>

  <!-- äº‹ä»¶ç»Ÿè®¡ -->
  <view class="stats-bar">
    <view class="stat-item">
      <text class="stat-label">äº‹ä»¶æ€»æ•°:</text>
      <text class="stat-value">{{serverInfo.eventsCount || 0}}</text>
    </view>
    <view class="stat-item">
      <text class="stat-label">ç­›é€‰å:</text>
      <text class="stat-value">{{filteredEvents.length}}</text>
    </view>
    <view class="stat-item">
      <text class="stat-label">AIåˆ†æ:</text>
      <text class="stat-value {{serverInfo.aiEnabled ? 'text-success' : 'text-warning'}}">
        {{serverInfo.aiEnabled ? 'å·²å¯ç”¨' : 'æ¨¡æ‹Ÿä¸­'}}
      </text>
    </view>
  </view>

  <!-- äº‹ä»¶åˆ—è¡¨ -->
  <view class="events-list">
    <view 
      wx:for="{{filteredEvents}}" 
      wx:key="id"
      class="event-item card {{item.importanceClass}}"
    >
      <!-- äº‹ä»¶å¤´éƒ¨ -->
      <view class="event-header" bindtap="onToggleExpand" data-index="{{index}}">
        <view class="event-time-info">
          <text class="event-time">{{item.displayTime}}</text>
          <text class="event-flag">{{item.flag}}</text>
          <text class="event-country">{{item.country}}</text>
        </view>
        
        <view class="event-importance">
          <text class="importance-icon">{{item.importanceIcon}}</text>
          <text class="importance-text {{item.importanceClass}}">
            {{item.importanceText}}
          </text>
        </view>
      </view>

      <!-- äº‹ä»¶ä¸»è¦å†…å®¹ -->
      <view class="event-content">
        <view class="event-name">{{item.name}}</view>
        
        <view class="event-data-grid">
          <view class="data-item">
            <text class="data-label">é¢„æœŸ:</text>
            <text class="data-value">{{item.forecast}}</text>
          </view>
          <view class="data-item">
            <text class="data-label">å‰å€¼:</text>
            <text class="data-value">{{item.previous}}</text>
          </view>
          <view class="data-item" wx:if="{{item.hasActual}}">
            <text class="data-label">å®é™…:</text>
            <text class="data-value {{item.actualClass}}">{{item.actual}}</text>
          </view>
          <view class="data-item">
            <text class="data-label">è´§å¸:</text>
            <text class="data-value">{{item.currency}}</text>
          </view>
        </view>
      </view>

      <!-- AIåˆ†æåŒºåŸŸ -->
      <view wx:if="{{item.ai_analysis}}" class="ai-analysis-section">
        <view class="ai-header" bindtap="onToggleExpand" data-index="{{index}}">
          <text class="ai-icon">ğŸ¤–</text>
          <text class="ai-title">AIåˆ†æ</text>
          <text class="ai-toggle">{{item.isExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
        
        <view 
          class="ai-content {{item.isExpanded ? 'expanded' : 'collapsed'}}"
          animation="{{item.animationData}}"
        >
          <text class="ai-text">{{item.ai_analysis}}</text>
        </view>
      </view>

      <!-- åº•éƒ¨æ“ä½œ -->
      <view class="event-footer">
        <view class="event-actions">
          <button class="btn-action" size="mini" data-event="{{item}}">
            ğŸ“ è®°ç¬”è®°
          </button>
          <button class="btn-action" size="mini" data-event="{{item}}">
            ğŸ”” è®¾æé†’
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!isLoading && filteredEvents.length === 0}}" class="empty-state">
    <text class="empty-icon">ğŸ“­</text>
    <text class="empty-text">æš‚æ— ç¬¦åˆç­›é€‰æ¡ä»¶çš„äº‹ä»¶</text>
    <button class="btn btn-primary mt-20" bindtap="onResetFilters">
      æ˜¾ç¤ºå…¨éƒ¨äº‹ä»¶
    </button>
  </view>

  <!-- åº•éƒ¨ä¿¡æ¯ -->
  <view class="footer-info">
    <text class="footer-text">
      æ•°æ®æ¥æº: TradingEconomics | AIåˆ†æ: {{serverInfo.aiEnabled ? 'å·²å¯ç”¨' : 'æ¨¡æ‹Ÿæ¨¡å¼'}}
    </text>
    <text class="footer-text">
      æœ€åæ›´æ–°: {{serverInfo.lastUpdated ? formatTime(serverInfo.lastUpdated) : '--'}}
    </text>
  </view>
</view>