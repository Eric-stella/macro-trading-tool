<!-- pages/summary/summary.wxml -->

<!-- åŠ è½½çŠ¶æ€ -->
<view wx:if="{{isLoading}}" class="loading-container">
  <view class="loading-spinner">
    <text class="loading-icon">ğŸ¤–</text>
    <text class="loading-text">AIæ­£åœ¨ç”Ÿæˆä»Šæ—¥æ€»ç»“...</text>
  </view>
</view>

<!-- ä¸»å†…å®¹ -->
<view wx:if="{{!isLoading}}" class="container fade-in">
  
  <!-- å¤´éƒ¨ -->
  <view class="summary-header">
    <view class="header-main">
      <text class="title">ğŸ¤– AIæ¯æ—¥å¸‚åœºæ€»ç»“</text>
      <text class="subtitle">
        ç”Ÿæˆæ—¶é—´: {{serverInfo.lastUpdated ? formatTime(serverInfo.lastUpdated) : '--'}}
      </text>
    </view>
    
    <view class="header-actions">
      <button class="btn-icon" bindtap="copySummary">
        <text class="icon-copy">ğŸ“‹</text>
      </button>
      <button 
        class="btn-refresh {{isRefreshing ? 'refreshing' : ''}}"
        bindtap="refreshData"
        disabled="{{isRefreshing}}"
      >
        {{isRefreshing ? 'åˆ·æ–°ä¸­' : 'åˆ·æ–°'}}
      </button>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-cards">
    <view class="stat-card">
      <text class="stat-icon">ğŸ“Š</text>
      <text class="stat-label">æ€»äº‹ä»¶æ•°</text>
      <text class="stat-value">{{analysisStats.totalEvents}}</text>
    </view>
    
    <view class="stat-card">
      <text class="stat-icon">ğŸ”¥</text>
      <text class="stat-label">é«˜å½±å“äº‹ä»¶</text>
      <text class="stat-value">{{analysisStats.highImpact}}</text>
    </view>
    
    <view class="stat-card">
      <text class="stat-icon">ğŸ“ˆ</text>
      <text class="stat-label">å¸‚åœºæƒ…ç»ª</text>
      <text class="stat-value {{analysisStats.marketSentiment === 'é«˜æ³¢åŠ¨' ? 'text-danger' : 
                              analysisStats.marketSentiment === 'å¹³é™' ? 'text-success' : 'text-warning'}}">
        {{analysisStats.marketSentiment}}
      </text>
    </view>
  </view>

  <!-- AIæ€»ç»“å†…å®¹ -->
  <view class="summary-content card">
    <view wx:if="{{loadError}}" class="error-notice">
      <text class="error-icon">âš ï¸</text>
      <text class="error-text">æ•°æ®åŠ è½½å¼‚å¸¸ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®</text>
    </view>
    
    <view wx:for="{{formattedSummary}}" wx:key="index" class="summary-section">
      
      <!-- ç« èŠ‚æ ‡é¢˜ -->
      <view 
        wx:if="{{item.type === 'title'}}" 
        class="section-title {{expandedSections[getSectionKey(item.content)] ? 'expanded' : ''}}"
        data-section="{{getSectionKey(item.content)}}"
        bindtap="toggleSection"
      >
        <text class="section-icon">{{item.icon}}</text>
        <text class="section-text">{{item.content}}</text>
        <text class="section-toggle">
          {{expandedSections[getSectionKey(item.content)] ? 'â–¼' : 'â–¶'}}
        </text>
      </view>
      
      <!-- ç« èŠ‚å†…å®¹ -->
      <view 
        wx:if="{{item.type !== 'title' && expandedSections[getParentSection(index)]}}"
        class="section-content {{item.type}}"
      >
        <text class="content-text">{{item.content}}</text>
      </view>
      
    </view>
  </view>

  <!-- AIçŠ¶æ€æç¤º -->
  <view class="ai-status">
    <text class="status-icon">{{serverInfo.aiEnabled ? 'âœ…' : 'ğŸ”§'}}</text>
    <text class="status-text">
      {{serverInfo.aiEnabled ? 'å®æ—¶AIåˆ†æ' : 'æ¨¡æ‹Ÿåˆ†ææ¨¡å¼'}}
    </text>
  </view>

  <!-- æ“ä½œæç¤º -->
  <view class="tips">
    <text class="tip-item">ğŸ’¡ ç‚¹å‡»ç« èŠ‚æ ‡é¢˜å±•å¼€/æ”¶èµ·å†…å®¹</text>
    <text class="tip-item">ğŸ“‹ ç‚¹å‡»å¤åˆ¶å›¾æ ‡å¤åˆ¶å®Œæ•´æ€»ç»“</text>
    <text class="tip-item">ğŸ”„ ä¸‹æ‹‰é¡µé¢æˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®æ›´æ–°æ•°æ®</text>
  </view>
</view>